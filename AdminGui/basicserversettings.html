<div class="basicserversettings">
	<form class="form-horizontal" role="form">
		<div class="form-group">
			<label class="col-lg-2 control-label" for="inputRepositoryServer"><a rel="tooltip" data-original-title="Central repository server from which services, plugins and extended data schemas can be loaded" data-placement="right">Repository Server</a></label>
			<div class="col-lg-8">
				<input type="text" class="form-control inputRepositoryServer" id="inputRepositoryServer" placeholder="Name">
			</div>
		</div>
		<div class="form-group">
			<label class="col-lg-2 control-label" for="siteAddress"><a rel="tooltip" data-original-title="Address where this BIMserver can primarily be found. Make sure you add a port number if the server is not running on port 80. Also include http:// or https://" data-placement="right">Site address</a></label>
			<div class="col-lg-8">
				<input type="text" class="form-control siteAddress" id="siteAddress" placeholder="Name">
			</div>
		</div>
		<div class="form-group">
			<label class="col-lg-2 control-label" for="smtpServer"><a rel="tooltip" data-original-title="SMTP server to use for sending emails" data-placement="right">SMTP server</a></label>
			<div class="col-lg-8">
				<input type="text" class="form-control smtpServer" id="smtpServer" placeholder="Name">
			</div>
		</div>
		<div class="form-group">
			<label class="col-lg-2 control-label" for="smtpUsername"><a rel="tooltip" data-original-title="SMTP username" data-placement="right">SMTP username</a></label>
			<div class="col-lg-8">
				<input type="text" class="form-control smtpUsername" id="smtpUsername" placeholder="SMTP username">
			</div>
		</div>
		<div class="form-group">
			<label class="col-lg-2 control-label" for="smtpPassword"><a rel="tooltip" data-original-title="SMTP password" data-placement="right">SMTP password</a></label>
			<div class="col-lg-8">
				<input type="password" class="form-control smtpPassword" id="smtpPassword" placeholder="SMTP password">
			</div>
		</div>
		<div class="form-group">
			<label class="col-lg-2 control-label" for="smtpPort"><a rel="tooltip" data-original-title="SMTP port" data-placement="right">SMTP port</a></label>
			<div class="col-lg-8">
				<input type="text" class="form-control smtpPort" id="smtpPort" placeholder="SMTP port">
			</div>
		</div>
		<div class="form-group">
			<label class="col-lg-2 control-label" for="smtpProtocol"><a rel="tooltip" data-original-title="SMTP protocol" data-placement="right">SMTP protocol</a></label>
			<div class="col-lg-8">
				<select class="form-control smtpProtocol" id="smtpProtocol">
					<option value="SMTP">SMTP</option>
					<option value="SMTPS">SMTPS</option>
				</select>
			</div>
		</div>
		<div class="form-group">
			<label class="col-lg-2 control-label" for="emailSenderAddress"><a rel="tooltip" data-original-title="Email address to send emails from" data-placement="right">Email sender address</a></label>
			<div class="col-lg-8">
				<input type="text" class="form-control emailSenderAddress" id="emailSenderAddress" placeholder="Name">
			</div>
		</div>
		<div class="form-group">
			<label class="col-lg-2 control-label" for="emailSenderName"><a rel="tooltip" data-original-title="Name to use for sending emails" data-placement="right">Email sender name</a></label>
			<div class="col-lg-8">
				<input type="text" class="form-control emailSenderName" id="emailSenderName" placeholder="Name">
			</div>
		</div>
		<div class="form-group">
			<label class="col-lg-2 control-label" for="protocolBuffersPort"><a rel="tooltip" data-original-title="Port to run the protocol buffers server on" data-placement="right">Protocol buffers port</a></label>
			<div class="col-lg-8">
				<input type="text" class="form-control protocolBuffersPort" id="protocolBuffersPort">
			</div>
		</div>
		<div class="form-group">
			<label class="col-lg-2 control-label" for="sessionTimeOutSeconds"><a rel="tooltip" data-original-title="Session timeout in seconds" data-placement="right">Session timeout (s)</a></label>
			<div class="col-lg-8">
				<input type="text" class="form-control sessionTimeOutSeconds" id="sessionTimeOutSeconds">
			</div>
		</div>
		<div class="form-group">
			<div class="col-lg-8">
				<label class="checkbox" for="hideUserList"><a rel="tooltip" data-original-title="Whether to hide the list of users for non-admin users" data-placement="right">Hide userlist for non-admin users</a>
					<input type="checkbox" class="hideUserList" id="hideUserList">
				</label>
			</div>
		</div>
		<div class="form-group">
			<div class="col-lg-8">
				<label class="checkbox"><a rel="tooltip" data-original-title="Whether serialized versions of models should be cached on disk. The first time a model is downloaded a cache file will be created. The server administrator is responsible for cleaning up cached files" data-placement="right">Cache output files</a>
					<input type="checkbox" class="input-xxlarge cacheOutputFiles">
				</label>
				<button class="btn btn-default clearCacheButton">Clear cache</button>
			</div>
		</div>
		<div class="form-group">
			<div class="col-lg-8">
				<label class="checkbox"><a rel="tooltip" data-original-title="Whether checkin-merging is enabled" data-placement="right">Checkin merging enabled</a>
					<input type="checkbox" class="checkinMergingEnabled">
				</label>
			</div>
		</div>
		<div class="form-group">
			<div class="col-lg-8">
				<label class="checkbox"><a rel="tooltip" data-original-title="Whether geometry reuse is enabled" data-placement="right">Geometry reuse</a>
					<input type="checkbox" class="geometryReuseEnabled">
				</label>
			</div>
		</div>
		<div class="form-group">
			<div class="col-lg-8">
				<label class="checkbox"><a rel="tooltip" data-original-title="Whether to generate geometry on checkin" data-placement="right">Generate geometry on checkin</a>
					<input type="checkbox" class="generateGeometryCheckin">
				</label>
			</div>
		</div>
		<div class="form-group">
			<label class="control-label col-lg-2"><a rel="tooltip" data-original-title="Maximum amount of processes to use concurrently when generating geometry for 1 revision" data-placement="right">Max Render Engine Processes (BETA)</a>
			</label>
			<div class="col-lg-8">
				<input type="text" class="form-control renderEngineProcesses">
			</div>
		</div>
		<div class="form-group">
			<div class="col-lg-8">
				<label class="checkbox"><a rel="tooltip" data-original-title="Allow user to create top level projects" data-placement="right">Allow user to create top level projects</a>
					<input type="checkbox" class="createTopLevelProjects">
				</label>
			</div>
		</div>
		<div class="form-group">
			<div class="col-lg-8">
				<label class="checkbox"><a rel="tooltip" data-original-title="Whether to allow users to register themselves" data-placement="right">Allow self registration</a>
					<input type="checkbox" class="allowSelfRegistration"/>
				</label>
			</div>
		</div>
		<div class="form-group">
			<div class="col-lg-8">
				<label class="checkbox"><a rel="tooltip" data-original-title="Whether a confirmation e-mail should be send after a new user has been registered" data-placement="right">Send confirmation email after registration</a>
					<input type="checkbox" class="sendConfirmationEmailAfterRegistration"/>
				</label>
			</div>
		</div>
		<div class="form-group">
			<div class="col-lg-8">
				<label class="checkbox"><a rel="tooltip" data-original-title="Whether an email should be send to all authorized users of a project when there is new revision" data-placement="right">Send email on new revision</a>
					<input type="checkbox" class="sendEmailOnNewRevision"/>
				</label>
			</div>
		</div>
		<div class="form-group">
			<div class="col-lg-8">
				<label class="checkbox"><a rel="tooltip" data-original-title="Whether only whitelisted (below) domains should be authorized to connect" data-placement="right">Only white listed domains</a>
					<input type="checkbox" class="allowOnlyWhitelisted"/>
				</label>
			</div>
		</div>
		<div class="form-group">
			<label class="col-lg-2 control-label"><a rel="tooltip" data-original-title="Select from which referred domains web browsers can connect to this BIMserver. More information about this can be found by searching for 'CORS'" data-placement="right">Whitelisted domains</a></label>
			<div class="col-lg-8 whiteListedDomains">
			</div>
		</div>
	</form>
</div>
<script>
function BasicServerSettings(main, serversettings) {
	var othis = this;
	othis.change = false;
	
	this.show = function(){};
	
	this.removeDomainButton = function(){
		$(this).parent().remove();		
		othis.change = true;
		othis.save();
	};

	this.checkWhiteListedDomains = function() {
		othis.change = true;
		var empty = 0;
		$(".basicserversettings .whiteListedDomainDiv").each(function(){
			if ($(this).find(".whiteListedDomain").val() == "") {
				empty++;
				$(this).find("button").hide();
			} else {
				$(this).find("button").show();
			}
		});
		if (empty == 0) {
			othis.addWhiteListedDomain("");
		} else if (empty > 1) {
			var found = 0;
			$(".basicserversettings .whiteListedDomainDiv").each(function(){
				if ($(this).find(".whiteListedDomain").val() == "") {
					found++;
					if (found > 1) {
						$(this).remove();
					}
				}
			});
		}
	};
	
	this.save = function(force) {
		if (othis.change) {
			var serverSettings = {
				__type: "SServerSettings"
			};
			serverSettings.whitelistedDomains = [];
			$(".basicserversettings .whiteListedDomainDiv").each(function(){
				var val = $(this).find("input").val();
				if (val != "") {
					serverSettings.whitelistedDomains.push(val);
				}
			});
			serverSettings.serviceRepositoryUrl = $(".basicserversettings .inputRepositoryServer").val();
			serverSettings.siteAddress = $(".basicserversettings .siteAddress").val();
			serverSettings.smtpServer = $(".basicserversettings .smtpServer").val();
			serverSettings.smtpProtocol = $(".basicserversettings .smtpProtocol").val();
			serverSettings.smtpPort = $(".basicserversettings .smtpPort").val();
			serverSettings.smtpUsername = $(".basicserversettings .smtpUsername").val();
			serverSettings.smtpPassword = $(".basicserversettings .smtpPassword").val();
			serverSettings.emailSenderAddress = $(".basicserversettings .emailSenderAddress").val();
			serverSettings.emailSenderName = $(".basicserversettings .emailSenderName").val();
			serverSettings.hideUserListForNonAdmin = $(".basicserversettings .hideUserList").prop("checked");
			serverSettings.protocolBuffersPort = $(".basicserversettings .protocolBuffersPort").val();
			serverSettings.sessionTimeOutSeconds = $(".basicserversettings .sessionTimeOutSeconds").val();
			serverSettings.cacheOutputFiles = $(".basicserversettings .cacheOutputFiles").prop("checked");
			serverSettings.renderEngineProcesses = $(".basicserversettings .renderEngineProcesses").val();
			serverSettings.reuseGeometry = $(".basicserversettings .geometryReuseEnabled").prop("checked");
			serverSettings.checkinMergingEnabled = $(".basicserversettings .checkinMergingEnabled").prop("checked");
			serverSettings.allowUsersToCreateTopLevelProjects = $(".basicserversettings .createTopLevelProjects").prop("checked");
			serverSettings.allowSelfRegistration = $(".basicserversettings .allowSelfRegistration").prop("checked");
			serverSettings.sendConfirmationEmailAfterRegistration = $(".basicserversettings .sendConfirmationEmailAfterRegistration").prop("checked");
			serverSettings.sendEmailOnNewRevision = $(".basicserversettings .sendEmailOnNewRevision").prop("checked");
			serverSettings.allowOnlyWhitelisted = $(".basicserversettings .allowOnlyWhitelisted").prop("checked");
			serverSettings.generateGeometryOnCheckin = $(".basicserversettings .generateGeometryCheckin").prop("checked");
			Global.bimServerApi.callWithFullIndication("SettingsInterface", "setServerSettings", {serverSettings: serverSettings}, function(data){
				othis.change = false;
			});
		}
	};

	this.addWhiteListedDomain = function(domain) {
		var div = $("<div class=\"whiteListedDomainDiv\">");
		var input = $("<input type=\"text\" class=\"form-control whiteListedDomain input-xlarge\">");
		input.val(domain);
		if (domain == "") {
			input.attr("placeHolder", "Add a new domain");
		}
		var button = $("<button class=\"btn btn-small removeDomainButton\"><i class=\"icon-minus\"/></button>");
		button.attr("title", "Remove domain");
		button.click(othis.removeDomainButton);
		div.append(input);
		input.blur(othis.save);
		input.keyup(othis.checkWhiteListedDomains);
		div.append(button);
		if (domain == "") {
			button.hide();
		}
		$(".basicserversettings .whiteListedDomains").append(div);
	};
	
	this.loadSettings = function() {
		Global.bimServerApi.call("SettingsInterface", "getServerSettings", {}, function(data){
			$(".basicserversettings .inputRepositoryServer").val(data.serviceRepositoryUrl);
			$(".basicserversettings .siteAddress").val(data.siteAddress);
			$(".basicserversettings .smtpServer").val(data.smtpServer);
			$(".basicserversettings .smtpUsername").val(data.smtpUsername);
			$(".basicserversettings .smtpPassword").val(data.smtpPassword);
			$(".basicserversettings .smtpPort").val(data.smtpPort);
			$(".basicserversettings .smtpProtocol").val(data.smtpProtocol);
			$(".basicserversettings .emailSenderAddress").val(data.emailSenderAddress);
			$(".basicserversettings .emailSenderName").val(data.emailSenderName);
			$(".basicserversettings .hideUserList").prop("checked", data.hideUserListForNonAdmin);
			$(".basicserversettings .protocolBuffersPort").val(data.protocolBuffersPort);
			$(".basicserversettings .renderEngineProcesses").val(data.renderEngineProcesses);
			$(".basicserversettings .sessionTimeOutSeconds").val(data.sessionTimeOutSeconds);
			$(".basicserversettings .cacheOutputFiles").prop("checked", data.cacheOutputFiles);
			$(".basicserversettings .geometryReuseEnabled").prop("checked", data.reuseGeometry);
			$(".basicserversettings .checkinMergingEnabled").prop("checked", data.checkinMergingEnabled);
			$(".basicserversettings .createTopLevelProjects").prop("checked", data.allowUsersToCreateTopLevelProjects);
			$(".basicserversettings .allowSelfRegistration").prop("checked", data.allowSelfRegistration);
			$(".basicserversettings .sendConfirmationEmailAfterRegistration").prop("checked", data.sendConfirmationEmailAfterRegistration);
			$(".basicserversettings .sendEmailOnNewRevision").prop("checked", data.sendEmailOnNewRevision);
			$(".basicserversettings .allowOnlyWhitelisted").prop("checked", data.allowOnlyWhitelisted);
			$(".basicserversettings .generateGeometryCheckin").prop("checked", data.generateGeometryOnCheckin);
			$(".basicserversettings .whiteListedDomains .whiteListedDomainDiv").remove();
			data.whitelistedDomains.forEach(function(domain){
				othis.addWhiteListedDomain(domain);
			});
			othis.addWhiteListedDomain("");
			othis.updateWhiteListedVisible(data.allowOnlyWhitelisted);
		});
	};
	
	this.updateWhiteListedVisible = function(allowOnlyWhitelisted){
		if (allowOnlyWhitelisted) {
			$(".basicserversettings .whiteListedDomains input").removeAttr("disabled");
			$(".basicserversettings .whiteListedDomains button").show();
			$(".basicserversettings .whiteListedDomains input").each(function(){
				if ($(this).val() == "") {
					$(this).show();
				}
			});
		} else {
			$(".basicserversettings .whiteListedDomains input").attr("disabled", "disabled");
			$(".basicserversettings .whiteListedDomains button").hide();
			$(".basicserversettings .whiteListedDomains input").each(function(){
				if ($(this).val() == "") {
					$(this).hide();
				}
			});
		}
	};
	
	this.clearCacheClick = function(event){
		event.preventDefault();
		Global.bimServerApi.call("AdminInterface", "clearOutputFileCache", {}, function(data){
			alert(data + " cache files removed");
		});
	};
	
	this.close = function(){
	};
	
	$(".basicserversettings select").change(function(){othis.change = true; othis.save()});
	$(".basicserversettings input[type='checkbox']").change(function(){othis.change = true; othis.save()});
	$(".basicserversettings input[type='text'], .basicserversettings input[type='password']").blur(othis.save);
	$(".basicserversettings input[type='text'], .basicserversettings input[type='password']").enterpress(othis.save);
	$(".basicserversettings input[type='text'], .basicserversettings input[type='password']").keyup(function(event){
		if (event.which != 13 && event.which != 9) {
			othis.change = true;
		}
	});
	$(".basicserversettings .allowOnlyWhitelisted").change(function(event){othis.updateWhiteListedVisible($(this).is(":checked"))});
	$(".basicserversettings .clearCacheButton").click(othis.clearCacheClick);
	
	$("[rel=tooltip]").tooltip();
	othis.loadSettings();
}
</script>